- name: Adding Microsoft.Storage service endpoint to the subnet
  azure_rm_subnet:
    resource_group: "{{ global.eu.resource_group }}"
    virtual_network_name: "{{ global.eu.vnet_name }}"
    name: "{{ global.eu.subnet_name_eu_1 }}"
    address_prefixes_cidr: "{{ global.eu.subnet1 }}"
    service_endpoints:
      - service: 'Microsoft.Storage'

- name: Configure firewall and virtual networks fro storage account
  azure_rm_storageaccount:
    resource_group: "{{ global.eu.resource_group }}"
    name: "{{ global.storage.account_name}}"
    type: Standard_RAGRS
    network_acls:
      bypass: AzureServices,Metrics
      default_action: Deny
      virtual_network_rules:
        - id: /subscriptions/mySubscriptionId/resourceGroups/myResourceGroup/providers/Microsoft.Network/virtualNetworks/myVnet/subnets/mySubnet
          action: Allow
